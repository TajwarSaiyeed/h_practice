name: CD - Deploy to Production

# Only run when you're ready to deploy
# Uncomment the trigger when you have EC2 setup
on:
  workflow_dispatch:  # Manual trigger from GitHub UI
  # push:
  #   branches: [ main ]
  #   paths-ignore:
  #     - 'README.md'
  #     - 'docs/**'
  #     - '*.md'

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat << EOF > .env
          NODE_ENV=production
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # User Service
          USER_SERVICE_PORT=3001
          USER_DB_USER=${{ secrets.USER_DB_USER }}
          USER_DB_PASSWORD=${{ secrets.USER_DB_PASSWORD }}
          USER_DB_NAME=user_db
          USER_DATABASE_URL=postgresql://${{ secrets.USER_DB_USER }}:${{ secrets.USER_DB_PASSWORD }}@user-db:5432/user_db?schema=public
          
          # Post Service
          POST_SERVICE_PORT=3002
          POST_DB_USER=${{ secrets.POST_DB_USER }}
          POST_DB_PASSWORD=${{ secrets.POST_DB_PASSWORD }}
          POST_DB_NAME=post_db
          POST_DATABASE_URL=postgresql://${{ secrets.POST_DB_USER }}:${{ secrets.POST_DB_PASSWORD }}@post-db:5432/post_db?schema=public
          
          # Interaction Service
          INTERACTION_SERVICE_PORT=3003
          INTERACTION_DB_USER=${{ secrets.INTERACTION_DB_USER }}
          INTERACTION_DB_PASSWORD=${{ secrets.INTERACTION_DB_PASSWORD }}
          INTERACTION_DB_NAME=interaction_db
          INTERACTION_DATABASE_URL=postgresql://${{ secrets.INTERACTION_DB_USER }}:${{ secrets.INTERACTION_DB_PASSWORD }}@interaction-db:5432/interaction_db?schema=public
          
          # Notification Service
          NOTIFICATION_SERVICE_PORT=3004
          
          # RabbitMQ
          RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
          RABBITMQ_DEFAULT_USER=guest
          RABBITMQ_DEFAULT_PASS=guest
          
          # Grafana
          GF_SECURITY_ADMIN_PASSWORD=${{ secrets.GRAFANA_PASSWORD }}
          EOF

      - name: Copy files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "/home/${{ secrets.EC2_USERNAME }}/h_practice"
          rm: false

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/${{ secrets.EC2_USERNAME }}/h_practice
            
            # Pull latest images
            docker compose pull
            
            # Run database migrations
            docker compose run --rm user-service pnpm prisma migrate deploy
            docker compose run --rm post-service pnpm prisma migrate deploy
            docker compose run --rm interaction-service pnpm prisma migrate deploy
            
            # Restart services with zero-downtime
            docker compose up -d --build --force-recreate
            
            # Clean up old images
            docker image prune -af
            
            # Health check
            sleep 10
            curl -f http://localhost/api/users/health || exit 1
            curl -f http://localhost/api/posts/health || exit 1
            curl -f http://localhost/api/interactions/health || exit 1
            
            echo "Deployment successful!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi
